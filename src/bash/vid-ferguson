#!/bin/bash

# (c) Patryk Czarnik
# Distributed under MIT License. See LICENCE file in the root directory for details.

# This script calls vid-process, but first it sets the default image sizes
# (cropping and scaling) for the Ferguson camera HD recordings.

usage="vid-fergusson-hd [options] infile [infile...]
where options are:
  -h  -- prints this usage message
  -o output_file -- sets output file
  -c width:height:left_offset:bottom_offset -- specification of the cropping rectangle, applied to the original input
  -r width:height -- final video size, to which the cropped image is resized
  -p spec -- picture size policy; it gives several predefined settings for -c and -r and can be used instead:
     fhd-medium2 -- -c 1600:800:160:216 -r 960:480
     hd-medium2 -- -c 1200:600:40:72 -r 960:480
     fhd-big2 -- -c 1600:800:160:216 -r 1200:600
     hd-big2 -- -c 1200:600:40:72 # no resize
  -s expr -- speed (increased this many times); you can use expressions like 2002/1000
  -f number -- frames per second in the result
  There is a different way to set speed-related arguments suited for Ferguson camera videos:
  -x N -- simplifying things: the video speed is increased N times;
              to be precise: result speed is N*1001/1000
  -3 -- changes the meaning of -x parameter: divides the number by 3,
        so that the result speed is N*1001/3000
  -F M -- the intensity of frame dropping, every M-th frame is kept,
     the rest is dropped; defaults to the value of -x argument,
     and then the resulting fps is equal to 30 (assuming 29.9 in the source);
     when lower than -x, it will result in a higher fps (e.g. -x 4 -F 2 will give fps 60),
     when higher than -x, it will give a lower fps (e.g. -x 2 -F 4 leads to fps 15)
  -b bitrate -- values 2000-3000 give good results for 800x600 video size or similar  
"

# Reading all available options. Their values are passed to the main script via variables.

mult=1

while getopts "ho:c:r:p:s:f:x:3F:b:" opt; do
  case "$opt" in
  h|\?)
     echo "$usage"
     exit 1
     ;;
  o) output="$OPTARG"
     ;;
  c) crop="$OPTARG"
     ;;
  r) resize="$OPTARG"
     ;;
  p) policy="$OPTARG"
     ;;
  s) speed="$OPTARG"
     ;;
  f) fps="$OPTARG"
     ;;
  x) xspeed="$OPTARG"
     ;;
  3) mult=3
     ;;
  F) fdrop="$OPTARG"
     ;;
  b) bitrate="$OPTARG"
     ;;
  esac
done

shift $(($OPTIND - 1))

# Handling -p option
case "$policy" in
  fhd-medium2)
    crop="1600:800:160:216"
    resize="960:480"
    ;;
  hd-medium2)
    cop="1200:600:40:72"
    resize="960:480"
    ;;
  fhd-big2)
    crop="1600:800:160:216"
    resize="1200:600"
    ;;
  hd-big2)
    crop="1200:600:40:72"
    resize=""
    ;;
esac

# Handling -x and -F options
if [ -n "$xspeed" -o -n "$fdrop" ]
then
  if [ -z "$xspeed" ]
  then xspeed=1
  fi
  speed="$(($xspeed * 1001))/$(($mult * 1000))"
  if [ -n "$fdrop" ]
  then fps="$((30 * $xspeed / $fdrop / $mult))"
  elif [ -z "$fps" ]
  then fps="30"
  fi
fi

# echo "speed = $speed"
# echo "fps = $fps"

# Calling the main script
vid-process "$@"
